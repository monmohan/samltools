package samltools

import (
	"crypto"
	"crypto/rand"
	"crypto/rsa"
	"crypto/x509"
	"encoding/base64"
	"encoding/pem"
	"encoding/xml"
	"fmt"
	"io/ioutil"
	"log"
	"os"
	"testing"
	"time"

	mrand "math/rand"

	"github.com/beevik/etree"
	dsig "github.com/russellhaering/goxmldsig"
)

func TestXMLGen(t *testing.T) {
	req := &AuthnRequest{
		SamlpAttr:       "urn:oasis:names:tc:SAML:2.0:protocol",
		ID:              "123",
		IssueInstant:    time.Now().Format(time.RFC3339),
		ProtocolBinding: "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect",
		Version:         "2.0",
		Issuer:          Issuer{Namespace: "urn:oasis:names:tc:SAML:2.0:assertion", Value: "http://msinghlocal.saml.com"},
	}
	output, err := xml.MarshalIndent(req, "  ", "    ")
	if err != nil {
		fmt.Printf("error: %v\n", err)
	}

	os.Stdout.Write(output)
}

func TestValidateSignature(t *testing.T) {
	//Sample Auth0 SAML Assertion
	var resp = `PHNhbWxwOlJlc3BvbnNlIHhtbG5zOnNhbWxwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIElEPSJfNjJiMDkzYjMzODBhYTA1NDAzMGEiICBJblJlc3BvbnNlVG89Il8yOTkzODU5MTAyNDk1MTQ2OTYzIiAgVmVyc2lvbj0iMi4wIiBJc3N1ZUluc3RhbnQ9IjIwMjEtMDgtMTVUMDk6MTY6MjUuNzY1WiIgIERlc3RpbmF0aW9uPSJodHRwOi8vc3Auc2FtbHRvb2xzLmNvbTo0NTY3L2Fzc2VydGlvbiI+PHNhbWw6SXNzdWVyIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPnVybjpkZXYtZWp0bDk4OHcuYXV0aDAuY29tPC9zYW1sOklzc3Vlcj48c2FtbHA6U3RhdHVzPjxzYW1scDpTdGF0dXNDb2RlIFZhbHVlPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6c3RhdHVzOlN1Y2Nlc3MiLz48L3NhbWxwOlN0YXR1cz48c2FtbDpBc3NlcnRpb24geG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiIgVmVyc2lvbj0iMi4wIiBJRD0iX3lIcVkyU2pDVlVoZVFQVXYzVWROdVdEaHpQcXNPa1dMIiBJc3N1ZUluc3RhbnQ9IjIwMjEtMDgtMTVUMDk6MTY6MjUuNzU0WiI+PHNhbWw6SXNzdWVyPnVybjpkZXYtZWp0bDk4OHcuYXV0aDAuY29tPC9zYW1sOklzc3Vlcj48U2lnbmF0dXJlIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj48U2lnbmVkSW5mbz48Q2Fub25pY2FsaXphdGlvbk1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjxTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjcnNhLXNoYTEiLz48UmVmZXJlbmNlIFVSST0iI195SHFZMlNqQ1ZVaGVRUFV2M1VkTnVXRGh6UHFzT2tXTCI+PFRyYW5zZm9ybXM+PFRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNlbnZlbG9wZWQtc2lnbmF0dXJlIi8+PFRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjwvVHJhbnNmb3Jtcz48RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnI3NoYTEiLz48RGlnZXN0VmFsdWU+L29oakpjSWx0RXR0N1pORHVrMXN6M1o4dDFzPTwvRGlnZXN0VmFsdWU+PC9SZWZlcmVuY2U+PC9TaWduZWRJbmZvPjxTaWduYXR1cmVWYWx1ZT5FRW85WFY4VXFjWVhPYnc1dy8yM0c5VEljQ0c2RExlT0tYOXVWdVB3ZzRZMDZQRlJBUlpxbEw2NTIrblRVSGg3R0wyMm9WbzZGR2hQK2JpY2FlbXkrL01wNHpZQUtDa0tEQ3luQ09mK0M3U1hZN0p5MEkzM29QdGlsTTUwNWhlSEsycFFZQzNNcFpVbkxwdTNIaElvdU1Vek5naXJNcHF5S2RSTUFjcjlpRmFnQUk1Q1Q5aWovVUEzSldGUVd3VTA4M3lRMjcrNzl1ZWV4R09mcVhIaUoveHYvWjE1dGVMSHJwdjZzUkFsek9MVlVJQmxva3JabzlaQ2orY3pwWjlSOUtyVEVDdjl6Mzd1RUg3S2JyQm5OdHovUlZ1VnhRaWhVTDZzR1FlV2QyVURJL2E0cGJIeTRrVVZ3TFhkRXhmdko4Ly9vb3gxT0dDdGtyRTNlU3lqZmc9PTwvU2lnbmF0dXJlVmFsdWU+PEtleUluZm8+PFg1MDlEYXRhPjxYNTA5Q2VydGlmaWNhdGU+TUlJREJ6Q0NBZStnQXdJQkFnSUpha29QaG8wTUpyNTZNQTBHQ1NxR1NJYjNEUUVCQ3dVQU1DRXhIekFkQmdOVkJBTVRGbVJsZGkxbGFuUnNPVGc0ZHk1aGRYUm9NQzVqYjIwd0hoY05NVGt4TURJNU1qSXdOekl5V2hjTk16TXdOekEzTWpJd056SXlXakFoTVI4d0hRWURWUVFERXhaa1pYWXRaV3AwYkRrNE9IY3VZWFYwYURBdVkyOXRNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXprTTFRSGNQMHY4Ym13UTJmZDNQajZ1bkNUeDVrOExzVzljdUx0VWhBamp6UkdwU0V3R0NLRWdpMWVqMiswQ3hjczF0MHd6aE8relN2MVRKYnNESTB4ODYyUElGRXMzeGtHcVBaVTZyZlFNenZDbW5jQWNNanVXN3IvWmV3bTBzNThvUkd5aWMxT3lwOHhpeTc4Y3psQkcwM2prLysvdmR0dEpraWU4cFVjOUFIQnVNeEFhVjRpUE4zelNpL0o1T1ZTbG92azYwN0gzQVVpTDNCZmc0c3NTMWJzSnZhRkcwa3VOc2NvaVArcUxSVGpGSzZMelpTOTlWeGVnZU56dHRxR2J0ajVCd05nYnR1enJJeWZMbVlCLzlWZ0V3K1FkYVFIdnhvQXZEMGY3YVlzYUoxUjZycnF4bysxUHVuN2oxL2g3a09DR0IwVWNIRExEdzdnYVAvd0lEQVFBQm8wSXdRREFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQjBHQTFVZERnUVdCQlF3SW9vNlF6elVML1RjTlZwTEdyTGRkM0RBSXpBT0JnTlZIUThCQWY4RUJBTUNBb1F3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUxiOFF5Y1JtYXV5Qy9IUldSeFRibDB3MjMxSFRBVllpelFxaEZRRmwzYmVTUUloZXhHaWsrSCtCNHZlMnJ2OTRRUkQzTGxyYVVwK0oyNndMRzg5RW5TQ3VDby9PeFBBcStseE82aE5mNm9LSitZMmY0OGF3SU94b2xPMGY4OXFYM0tNSWtBQlh3S2JZVWNkK1NCSFg1WlAxVjljdkpFeUgwczNGcTlPYnlzUENIMmoySGpnejNXTUlmZlNGTWFPMERJZmgzZU5udjloS1F3YXZVTzdmTC9qcWhCbDRReEkyZ015U2kwTmk3UGdBbEJneEJ4NllVcDU5cS9sek1nQWYxOUdPRU92STdsNGRBMGJjOXBkc203T2hpbXNrdk9VU1pZaTVQejNuL2kvY1RWS0tobGo2TnlJTmtNWGxYR2d5TTl2RUJwZGNJcE9Xbi8xSDVRVnk4UT08L1g1MDlDZXJ0aWZpY2F0ZT48L1g1MDlEYXRhPjwvS2V5SW5mbz48L1NpZ25hdHVyZT48c2FtbDpTdWJqZWN0PjxzYW1sOk5hbWVJRCBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjEuMTpuYW1laWQtZm9ybWF0OnVuc3BlY2lmaWVkIj5hdXRoMHw1ZmZhZmI0OGQ5ZmY5YjAwNzBjNTJlYWI8L3NhbWw6TmFtZUlEPjxzYW1sOlN1YmplY3RDb25maXJtYXRpb24gTWV0aG9kPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6Y206YmVhcmVyIj48c2FtbDpTdWJqZWN0Q29uZmlybWF0aW9uRGF0YSBOb3RPbk9yQWZ0ZXI9IjIwMjEtMDgtMTVUMTA6MTY6MjUuNzU0WiIgUmVjaXBpZW50PSJodHRwOi8vc3Auc2FtbHRvb2xzLmNvbTo0NTY3L2Fzc2VydGlvbiIgSW5SZXNwb25zZVRvPSJfMjk5Mzg1OTEwMjQ5NTE0Njk2MyIvPjwvc2FtbDpTdWJqZWN0Q29uZmlybWF0aW9uPjwvc2FtbDpTdWJqZWN0PjxzYW1sOkNvbmRpdGlvbnMgTm90QmVmb3JlPSIyMDIxLTA4LTE1VDA5OjE2OjI1Ljc1NFoiIE5vdE9uT3JBZnRlcj0iMjAyMS0wOC0xNVQxMDoxNjoyNS43NTRaIj48c2FtbDpBdWRpZW5jZVJlc3RyaWN0aW9uPjxzYW1sOkF1ZGllbmNlPnVybjptc2luZ2guc2FtbHRvb2xzOnNwPC9zYW1sOkF1ZGllbmNlPjwvc2FtbDpBdWRpZW5jZVJlc3RyaWN0aW9uPjwvc2FtbDpDb25kaXRpb25zPjxzYW1sOkF1dGhuU3RhdGVtZW50IEF1dGhuSW5zdGFudD0iMjAyMS0wOC0xNVQwOToxNjoyNS43NTRaIiBTZXNzaW9uSW5kZXg9Il9GNTg5WWZVYjNMQUdEOU5pQ04waFAxR0lkRnNjcE1xUiI+PHNhbWw6QXV0aG5Db250ZXh0PjxzYW1sOkF1dGhuQ29udGV4dENsYXNzUmVmPnVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphYzpjbGFzc2VzOnVuc3BlY2lmaWVkPC9zYW1sOkF1dGhuQ29udGV4dENsYXNzUmVmPjwvc2FtbDpBdXRobkNvbnRleHQ+PC9zYW1sOkF1dGhuU3RhdGVtZW50PjxzYW1sOkF0dHJpYnV0ZVN0YXRlbWVudCB4bWxuczp4cz0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJuYW1lIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OmJhc2ljIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4c2k6dHlwZT0ieHM6c3RyaW5nIj5hdXRoMHw1ZmZhZmI0OGQ5ZmY5YjAwNzBjNTJlYWI8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iZW1haWwiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6YmFzaWMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhzaTp0eXBlPSJ4czpzdHJpbmciPmRldi5udWxsLmR1bXAuMUBnbWFpbC5jb208L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvdXBuIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVyaSI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeHNpOnR5cGU9InhzOnN0cmluZyI+ZGV2Lm51bGwuZHVtcC4xQGdtYWlsLmNvbTwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJodHRwOi8vc2NoZW1hcy5hdXRoMC5jb20vaWRlbnRpdGllcy9kZWZhdWx0L3Byb3ZpZGVyIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVyaSI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeHNpOnR5cGU9InhzOnN0cmluZyI+YXV0aDA8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iaHR0cDovL3NjaGVtYXMuYXV0aDAuY29tL2lkZW50aXRpZXMvZGVmYXVsdC9jb25uZWN0aW9uIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVyaSI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeHNpOnR5cGU9InhzOnN0cmluZyI+VXNlcm5hbWUtUGFzc3dvcmQtQXV0aGVudGljYXRpb248L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iaHR0cDovL3NjaGVtYXMuYXV0aDAuY29tL2lkZW50aXRpZXMvZGVmYXVsdC9pc1NvY2lhbCIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDp1cmkiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhzaTp0eXBlPSJ4czpib29sZWFuIj5mYWxzZTwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJodHRwOi8vc2NoZW1hcy5hdXRoMC5jb20vY2xpZW50SUQiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6dXJpIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4c2k6dHlwZT0ieHM6c3RyaW5nIj5scXJiV1dNWWMyNVVyQ2lZQTVQdDA2VTYyNWM0SzZETzwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJodHRwOi8vc2NoZW1hcy5hdXRoMC5jb20vY3JlYXRlZF9hdCIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDp1cmkiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhzaTp0eXBlPSJ4czphbnlUeXBlIj5TdW4gSmFuIDEwIDIwMjEgMTM6MDQ6MDggR01UKzAwMDAgKENvb3JkaW5hdGVkIFVuaXZlcnNhbCBUaW1lKTwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJodHRwOi8vc2NoZW1hcy5hdXRoMC5jb20vZW1haWxfdmVyaWZpZWQiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6dXJpIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4c2k6dHlwZT0ieHM6Ym9vbGVhbiI+ZmFsc2U8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iaHR0cDovL3NjaGVtYXMuYXV0aDAuY29tL25hbWUiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6dXJpIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4c2k6dHlwZT0ieHM6c3RyaW5nIj5kZXYubnVsbC5kdW1wLjFAZ21haWwuY29tPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIE5hbWU9Imh0dHA6Ly9zY2hlbWFzLmF1dGgwLmNvbS9uaWNrbmFtZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDp1cmkiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhzaTp0eXBlPSJ4czpzdHJpbmciPmRldi5udWxsLmR1bXAuMTwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBOYW1lPSJodHRwOi8vc2NoZW1hcy5hdXRoMC5jb20vcGljdHVyZSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDp1cmkiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhzaTp0eXBlPSJ4czpzdHJpbmciPmh0dHBzOi8vcy5ncmF2YXRhci5jb20vYXZhdGFyLzQzNTU3YzU4ZGY4NGE1NDY3NGUwNGQ1NTg5OWIyNTE3P3M9NDgwJmFtcDtyPXBnJmFtcDtkPWh0dHBzJTNBJTJGJTJGY2RuLmF1dGgwLmNvbSUyRmF2YXRhcnMlMkZkZS5wbmc8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iaHR0cDovL3NjaGVtYXMuYXV0aDAuY29tL3VwZGF0ZWRfYXQiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6dXJpIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4c2k6dHlwZT0ieHM6YW55VHlwZSI+U3VuIEF1ZyAxNSAyMDIxIDA5OjE2OjI0IEdNVCswMDAwIChDb29yZGluYXRlZCBVbml2ZXJzYWwgVGltZSk8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgTmFtZT0iaHR0cDovL3NjaGVtYXMuYXV0aDAuY29tL2xhc3RfcGFzc3dvcmRfcmVzZXQiIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphdHRybmFtZS1mb3JtYXQ6dXJpIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZSB4c2k6dHlwZT0ieHM6c3RyaW5nIj4yMDIxLTAxLTEyVDA2OjA2OjI3LjY4N1o8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48L3NhbWw6QXR0cmlidXRlU3RhdGVtZW50Pjwvc2FtbDpBc3NlcnRpb24+PC9zYW1scDpSZXNwb25zZT4=`
	var okta_resp = `PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c2FtbDJwOlJlc3BvbnNlIERlc3RpbmF0aW9uPSJodHRwOi8vc3Auc2FtbHRvb2xzLmNvbTo0NTY3L2Fzc2VydGlvbiIgSUQ9ImlkMTE3ODk2NTg2MTE0NTU2MzgxMjg3NDYwNDA2IiBJblJlc3BvbnNlVG89Il81MzAxMzk3NTczODUzMzU3OTA3IiBJc3N1ZUluc3RhbnQ9IjIwMjEtMDgtMTVUMDk6NTg6MzIuMjE2WiIgVmVyc2lvbj0iMi4wIiB4bWxuczpzYW1sMnA9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm90b2NvbCI+PHNhbWwyOklzc3VlciBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OmVudGl0eSIgeG1sbnM6c2FtbDI9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPmh0dHA6Ly93d3cub2t0YS5jb20vZXhrMTB5OXd4dDJtTVpOVDcwaDg8L3NhbWwyOklzc3Vlcj48ZHM6U2lnbmF0dXJlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj48ZHM6U2lnbmVkSW5mbz48ZHM6Q2Fub25pY2FsaXphdGlvbk1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjxkczpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNyc2Etc2hhMjU2Ii8+PGRzOlJlZmVyZW5jZSBVUkk9IiNpZDExNzg5NjU4NjExNDU1NjM4MTI4NzQ2MDQwNiI+PGRzOlRyYW5zZm9ybXM+PGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNlbnZlbG9wZWQtc2lnbmF0dXJlIi8+PGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjwvZHM6VHJhbnNmb3Jtcz48ZHM6RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjc2hhMjU2Ii8+PGRzOkRpZ2VzdFZhbHVlPit5ek5SNm5XQ1BDWWQ1N0VyNkhYMlVRN2lnU0x6VGtQZ3BIMEpPTWRnY3c9PC9kczpEaWdlc3RWYWx1ZT48L2RzOlJlZmVyZW5jZT48L2RzOlNpZ25lZEluZm8+PGRzOlNpZ25hdHVyZVZhbHVlPk1mSWwvck5vUEc1NkxoSkw0Um1NZFFtYmJBbFE4OFdvQTVQMDlQcWxnVUxHV2VGRHUzMXlHYlI2S01TSlZrd0c1bE9CSSs4SlBlUHhId0ExaTdQV2t2SEFRK0lLbmExdFRqTm9IQ0swc3VrdXFsd0FESjNXbDhlTXFzak8wMzVQQkpNRVhQTnM1ZTB4RXBoRmZtaXhEWk44TnZIRzY0bU5UN2hGZ2dScFJ2cVh5dWpEdEJIRlFSeXhmRXNvcHlHUkJsdGpEMW9NNUMzQ09BWGJtYWM4RkJMendPUEdTOWdWamsyZzczRTl4dVg3WVpEVTJ4WjlmNkFad0ZTUGd0TUI3M3RLMkNtMkRLRFoxZnhOVEtubXFZSWxiY0pMcE1scVNHbTh6c28xUzJuSjcxT293RXhmcFowTTNpd3Z3NUJadG5naGJ0cjBlbFJUVEsvMHBZVk9IZz09PC9kczpTaWduYXR1cmVWYWx1ZT48ZHM6S2V5SW5mbz48ZHM6WDUwOURhdGE+PGRzOlg1MDlDZXJ0aWZpY2F0ZT5NSUlEcWpDQ0FwS2dBd0lCQWdJR0FXanAxNFl6TUEwR0NTcUdTSWIzRFFFQkN3VUFNSUdWTVFzd0NRWURWUVFHRXdKVlV6RVRNQkVHCkExVUVDQXdLUTJGc2FXWnZjbTVwWVRFV01CUUdBMVVFQnd3TlUyRnVJRVp5WVc1amFYTmpiekVOTUFzR0ExVUVDZ3dFVDJ0MFlURVUKTUJJR0ExVUVDd3dMVTFOUFVISnZkbWxrWlhJeEZqQVVCZ05WQkFNTURXRjFkRzlrWlhOckxYUmxjM1F4SERBYUJna3Foa2lHOXcwQgpDUUVXRFdsdVptOUFiMnQwWVM1amIyMHdIaGNOTVRrd01qRTBNREl5T1RReVdoY05Namt3TWpFME1ESXpNRFF5V2pDQmxURUxNQWtHCkExVUVCaE1DVlZNeEV6QVJCZ05WQkFnTUNrTmhiR2xtYjNKdWFXRXhGakFVQmdOVkJBY01EVk5oYmlCR2NtRnVZMmx6WTI4eERUQUwKQmdOVkJBb01CRTlyZEdFeEZEQVNCZ05WQkFzTUMxTlRUMUJ5YjNacFpHVnlNUll3RkFZRFZRUUREQTFoZFhSdlpHVnpheTEwWlhOMApNUnd3R2dZSktvWklodmNOQVFrQkZnMXBibVp2UUc5cmRHRXVZMjl0TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCCkNnS0NBUUVBcG91TnI5UHo4ekZFNFBEbkJFeXNTaUdNelVlTVhkMm1rbmZEM2Jtc0ZSKzdJeEtpL1JpSlkzZXVOVndqVk9GT1lmZlEKTG1tYkNXZ2lGUThYaEFGT0FmUlJzTzhacGlIQzM5K2tBK2V3ZU5kMzh4N0V2TXFjMnlkRjkvNGxHNWQ5SmpnOHR4K2tMK3Vtd1RnMQpPT1M2a1hjMHFGVG1WMFgwZVZFQkd2SitxZm1tV1Vva0xaVEp1V3ZGQm1KRG1CQmRFdUIreElTQ1F0THIyVnFtTHVKWVk4YzdzU2toCnlyMGkyZGhpM0kwK0tRU1RHOWRXU3ZvSUwxS3JXUkJIclJHYzBtWm9HeWRLV2RpZTJJaklhQzNaR1dhcnJaRUYvZzJhVHE0ck4vSGMKdWY1RGhwWUJmVE8wc1hJZnpOYk1WeXU0YXFIdzJVU0dvejdlMEp4bWF4d0JvUUlEQVFBQk1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQgpBUUNCbWpPZ243OWRDYTNZSXphRWthZUcrOGlSU2pMa1NBQlAzcWEyRzdsTTZvYWtRWTh1RFpDTXZoNldid2RYNm5JcXV2VzdqeVNjCkQzQ3hSMmFzRk5nS3JzUjZ2bS9yZ3BXSitBVkFFRGY5bWZJVnJ4TmcrbXFCaGZQR2lXYUV0UEFRQTh4Tys5V2kxZnZVakRQU0VSUzcKbDArRGZpR0NzaGJ6d1puTitnLzRNT1hLdUpFZmhOenlDNTNaMEpNZEFlR1UrbHpuOUtGcmp0TFZLSDB1Q2FQZzNkSzVDTnhDVVFnVgo1UWJzOUlGd0t5MVFMNytaYk1MOXYrRklEM0NQWlRwVE96d1hVOWpLampnSmlFQ05QUXQ1TklNWlR5NmdyK2hmSkNqS3gxeXV4c3daCjc3alI4dWR6ODRsdFB4cjE5U1I4RkR1NWg2aFo5RzhFSlBJK0s3aHo8L2RzOlg1MDlDZXJ0aWZpY2F0ZT48L2RzOlg1MDlEYXRhPjwvZHM6S2V5SW5mbz48L2RzOlNpZ25hdHVyZT48c2FtbDJwOlN0YXR1cyB4bWxuczpzYW1sMnA9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm90b2NvbCI+PHNhbWwycDpTdGF0dXNDb2RlIFZhbHVlPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6c3RhdHVzOlN1Y2Nlc3MiLz48L3NhbWwycDpTdGF0dXM+PHNhbWwyOkFzc2VydGlvbiBJRD0iaWQxMTc4OTY1ODYxMTUzMDQ1OTE2NTYyMDM3NTEiIElzc3VlSW5zdGFudD0iMjAyMS0wOC0xNVQwOTo1ODozMi4yMTZaIiBWZXJzaW9uPSIyLjAiIHhtbG5zOnNhbWwyPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIj48c2FtbDI6SXNzdWVyIEZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOm5hbWVpZC1mb3JtYXQ6ZW50aXR5IiB4bWxuczpzYW1sMj0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+aHR0cDovL3d3dy5va3RhLmNvbS9leGsxMHk5d3h0Mm1NWk5UNzBoODwvc2FtbDI6SXNzdWVyPjxkczpTaWduYXR1cmUgeG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPjxkczpTaWduZWRJbmZvPjxkczpDYW5vbmljYWxpemF0aW9uTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8+PGRzOlNpZ25hdHVyZU1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZHNpZy1tb3JlI3JzYS1zaGEyNTYiLz48ZHM6UmVmZXJlbmNlIFVSST0iI2lkMTE3ODk2NTg2MTE1MzA0NTkxNjU2MjAzNzUxIj48ZHM6VHJhbnNmb3Jtcz48ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnI2VudmVsb3BlZC1zaWduYXR1cmUiLz48ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIi8+PC9kczpUcmFuc2Zvcm1zPjxkczpEaWdlc3RNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyNzaGEyNTYiLz48ZHM6RGlnZXN0VmFsdWU+WGthVE1UbSttTjdwTHl2aXgxUE9oS2tuanQxVUwrdnRuVkNMZG5WNzN4Zz08L2RzOkRpZ2VzdFZhbHVlPjwvZHM6UmVmZXJlbmNlPjwvZHM6U2lnbmVkSW5mbz48ZHM6U2lnbmF0dXJlVmFsdWU+VGhEelRGREhZWEl2ZVhxOGhzSVd1RnM3eXQraWZ6cm5DR294bm5nOTd3SzZmWVBQbUpibENzcEVFRnc1a004cFFkZ2hqSlRhOVc3SC9vSGxHWlhpbC9nT2RJVHhuQ2FUenhCeWRSL0kwOXdicEtVQnRIZDRtdDI0ZVcwQzN0eFhrcTQxWWR5TVcwQnJTbHkzNDZWSGk3TGxQbjNDbHdpTTYydS81U2tacUNBQUE0OEIwaHJNR3FZNlVQVnZRTUxqZUMvak1lZkRLS0NoRE9jUjI0ZXRpSGNpcHloZVVUdmFzSXNFOWxMYVZ3QXd1Q014M3dub2FZQ3I2YjJpODl1ZzNvWk1sOTgrbUxaYkMwTkcyQzVDZ1p2ZFpjT0xVcUkxYzNyN2ViRWZ6N1VWMUYzcHlEMmVSTGh6NzdvV1JrTEFKUUd0L0grc2E2cThGcE9PZEQxMy9BPT08L2RzOlNpZ25hdHVyZVZhbHVlPjxkczpLZXlJbmZvPjxkczpYNTA5RGF0YT48ZHM6WDUwOUNlcnRpZmljYXRlPk1JSURxakNDQXBLZ0F3SUJBZ0lHQVdqcDE0WXpNQTBHQ1NxR1NJYjNEUUVCQ3dVQU1JR1ZNUXN3Q1FZRFZRUUdFd0pWVXpFVE1CRUcKQTFVRUNBd0tRMkZzYVdadmNtNXBZVEVXTUJRR0ExVUVCd3dOVTJGdUlFWnlZVzVqYVhOamJ6RU5NQXNHQTFVRUNnd0VUMnQwWVRFVQpNQklHQTFVRUN3d0xVMU5QVUhKdmRtbGtaWEl4RmpBVUJnTlZCQU1NRFdGMWRHOWtaWE5yTFhSbGMzUXhIREFhQmdrcWhraUc5dzBCCkNRRVdEV2x1Wm05QWIydDBZUzVqYjIwd0hoY05NVGt3TWpFME1ESXlPVFF5V2hjTk1qa3dNakUwTURJek1EUXlXakNCbFRFTE1Ba0cKQTFVRUJoTUNWVk14RXpBUkJnTlZCQWdNQ2tOaGJHbG1iM0p1YVdFeEZqQVVCZ05WQkFjTURWTmhiaUJHY21GdVkybHpZMjh4RFRBTApCZ05WQkFvTUJFOXJkR0V4RkRBU0JnTlZCQXNNQzFOVFQxQnliM1pwWkdWeU1SWXdGQVlEVlFRRERBMWhkWFJ2WkdWemF5MTBaWE4wCk1Sd3dHZ1lKS29aSWh2Y05BUWtCRmcxcGJtWnZRRzlyZEdFdVkyOXRNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUIKQ2dLQ0FRRUFwb3VOcjlQejh6RkU0UERuQkV5c1NpR016VWVNWGQybWtuZkQzYm1zRlIrN0l4S2kvUmlKWTNldU5Wd2pWT0ZPWWZmUQpMbW1iQ1dnaUZROFhoQUZPQWZSUnNPOFpwaUhDMzkra0ErZXdlTmQzOHg3RXZNcWMyeWRGOS80bEc1ZDlKamc4dHgra0wrdW13VGcxCk9PUzZrWGMwcUZUbVYwWDBlVkVCR3ZKK3FmbW1XVW9rTFpUSnVXdkZCbUpEbUJCZEV1Qit4SVNDUXRMcjJWcW1MdUpZWThjN3NTa2gKeXIwaTJkaGkzSTArS1FTVEc5ZFdTdm9JTDFLcldSQkhyUkdjMG1ab0d5ZEtXZGllMklqSWFDM1pHV2FyclpFRi9nMmFUcTRyTi9IYwp1ZjVEaHBZQmZUTzBzWElmek5iTVZ5dTRhcUh3MlVTR296N2UwSnhtYXh3Qm9RSURBUUFCTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCCkFRQ0Jtak9nbjc5ZENhM1lJemFFa2FlRys4aVJTakxrU0FCUDNxYTJHN2xNNm9ha1FZOHVEWkNNdmg2V2J3ZFg2bklxdXZXN2p5U2MKRDNDeFIyYXNGTmdLcnNSNnZtL3JncFdKK0FWQUVEZjltZklWcnhOZyttcUJoZlBHaVdhRXRQQVFBOHhPKzlXaTFmdlVqRFBTRVJTNwpsMCtEZmlHQ3NoYnp3Wm5OK2cvNE1PWEt1SkVmaE56eUM1M1owSk1kQWVHVStsem45S0ZyanRMVktIMHVDYVBnM2RLNUNOeENVUWdWCjVRYnM5SUZ3S3kxUUw3K1piTUw5ditGSUQzQ1BaVHBUT3p3WFU5aktqamdKaUVDTlBRdDVOSU1aVHk2Z3IraGZKQ2pLeDF5dXhzd1oKNzdqUjh1ZHo4NGx0UHhyMTlTUjhGRHU1aDZoWjlHOEVKUEkrSzdoejwvZHM6WDUwOUNlcnRpZmljYXRlPjwvZHM6WDUwOURhdGE+PC9kczpLZXlJbmZvPjwvZHM6U2lnbmF0dXJlPjxzYW1sMjpTdWJqZWN0IHhtbG5zOnNhbWwyPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIj48c2FtbDI6TmFtZUlEIEZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6MS4xOm5hbWVpZC1mb3JtYXQ6dW5zcGVjaWZpZWQiPmRldi5udWxsLmR1bXAuMUBnbWFpbC5jb208L3NhbWwyOk5hbWVJRD48c2FtbDI6U3ViamVjdENvbmZpcm1hdGlvbiBNZXRob2Q9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpjbTpiZWFyZXIiPjxzYW1sMjpTdWJqZWN0Q29uZmlybWF0aW9uRGF0YSBJblJlc3BvbnNlVG89Il81MzAxMzk3NTczODUzMzU3OTA3IiBOb3RPbk9yQWZ0ZXI9IjIwMjEtMDgtMTVUMTA6MDM6MzIuMjE2WiIgUmVjaXBpZW50PSJodHRwOi8vc3Auc2FtbHRvb2xzLmNvbTo0NTY3L2Fzc2VydGlvbiIvPjwvc2FtbDI6U3ViamVjdENvbmZpcm1hdGlvbj48L3NhbWwyOlN1YmplY3Q+PHNhbWwyOkNvbmRpdGlvbnMgTm90QmVmb3JlPSIyMDIxLTA4LTE1VDA5OjUzOjMyLjIxNloiIE5vdE9uT3JBZnRlcj0iMjAyMS0wOC0xNVQxMDowMzozMi4yMTZaIiB4bWxuczpzYW1sMj0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFzc2VydGlvbiI+PHNhbWwyOkF1ZGllbmNlUmVzdHJpY3Rpb24+PHNhbWwyOkF1ZGllbmNlPnVybjpva3RhO2F1dG9kZXNrLXRlc3Qub2t0YXByZXZpZXcuY29tOnNhbWx0b29scy1zcDwvc2FtbDI6QXVkaWVuY2U+PC9zYW1sMjpBdWRpZW5jZVJlc3RyaWN0aW9uPjwvc2FtbDI6Q29uZGl0aW9ucz48c2FtbDI6QXV0aG5TdGF0ZW1lbnQgQXV0aG5JbnN0YW50PSIyMDIxLTA4LTE1VDA5OjU4OjMwLjgwOVoiIFNlc3Npb25JbmRleD0iXzUzMDEzOTc1NzM4NTMzNTc5MDciIHhtbG5zOnNhbWwyPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXNzZXJ0aW9uIj48c2FtbDI6QXV0aG5Db250ZXh0PjxzYW1sMjpBdXRobkNvbnRleHRDbGFzc1JlZj51cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YWM6Y2xhc3NlczpQYXNzd29yZFByb3RlY3RlZFRyYW5zcG9ydDwvc2FtbDI6QXV0aG5Db250ZXh0Q2xhc3NSZWY+PC9zYW1sMjpBdXRobkNvbnRleHQ+PC9zYW1sMjpBdXRoblN0YXRlbWVudD48L3NhbWwyOkFzc2VydGlvbj48L3NhbWwycDpSZXNwb25zZT4=`

	//Auth0 Cert
	validationContext, err := CreateValidationContextFromCertFile("./config/dev-ejtl988w.cer")
	if err != nil {
		t.Fatalf("Auth0 Validation Failed Err=%s", err)

	}
	err = ValidateAssertion(resp, validationContext)
	if err != nil {
		t.Fatalf("Auth0 Validation Failed Err=%s", err)

	}
	//Auth0 Cert
	validationContext, err = CreateValidationContextFromCertFile("./config/okta.cert")
	if err != nil {
		t.Fatalf("Okta Validation Failed Err=%s", err)

	}
	err = ValidateAssertion(okta_resp, validationContext)
	if err != nil {
		t.Fatalf("Okta Validation Failed Err=%s", err)

	}
}

func TestCreateAssertion(t *testing.T) {
	mrand.Seed(time.Now().UnixNano())

	//create assertion
	assertionID := fmt.Sprintf("_%d", mrand.Int())
	issueTime := time.Now().Format(time.RFC3339)
	notOnOrAfter := time.Now().Add(2 * time.Hour).Format(time.RFC3339)
	requestId := fmt.Sprintf("_%d", mrand.Int())
	doc := etree.NewDocument()
	asEl := doc.CreateElement("saml:Assertion")
	asEl.CreateAttr("xmlns:saml", "urn:oasis:names:tc:SAML:2.0:assertion")
	asEl.CreateAttr("Version", "2.0")
	asEl.CreateAttr("ID", assertionID)
	asEl.CreateAttr("IssueInstant", issueTime)
	//add Issuer
	asEl.CreateElement("saml:Issuer").CreateText("http://idp.samltools.com")

	addSubject(asEl, requestId, notOnOrAfter, "urn:auth0:dev-ejtl988w:auth0-as-sp")
	addConditions(asEl, notOnOrAfter, "https://dev-ejtl988w.auth0.com/login/callback?connection=auth0-as-sp")
	addAuthStatements(asEl, issueTime)

	attrStmts := asEl.CreateElement("saml:AttributeStatement")
	attrStmts.CreateAttr("xmlns", "http://www.w3.org/2001/XMLSchema")
	attrStmts.CreateAttr("xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance")
	createAttribute(attrStmts, "name", "IDPUser1")
	createAttribute(attrStmts, "email", "dev.null.dump.1@gmail.com")
	createAttribute(attrStmts, "userid", "IDPUser1")

	samlResp := createSAMLResponseElement(asEl, requestId)

	//randomKeyStore := dsig.RandomKeyStoreForTest()
	randomKeyStore := NewIDPKeyStore("./config/idp-samltools-privatekey.key")
	ctx := dsig.NewDefaultSigningContext(randomKeyStore)
	// Sign the element
	signedElement, err := ctx.SignEnveloped(asEl)
	if err != nil {
		panic(err)
	}
	samlResp.AddChild(signedElement)
	// Serialize the signed element. It is important not to modify the element
	// after it has been signed - even pretty-printing the XML will invalidate
	// the signature.
	fdoc := etree.NewDocument()
	fdoc.SetRoot(samlResp)
	fdoc.WriteTo(os.Stdout)

	bytes, err := fdoc.WriteToBytes()
	if err != nil {
		panic(err)
	}
	resp := base64.StdEncoding.EncodeToString(bytes)
	//Build context
	_, certBytes, _ := randomKeyStore.GetKeyPair()
	cert, err := x509.ParseCertificate(certBytes)
	if err != nil {
		panic(err)
	}

	certificateStore := dsig.MemoryX509CertificateStore{
		Roots: []*x509.Certificate{cert},
	}

	validationContext := dsig.NewDefaultValidationContext(&certificateStore)
	validationContext.IdAttribute = "ID"

	err = ValidateAssertion(resp, validationContext)
	if err != nil {
		t.Fatalf("failed to validate signature  %s", err.Error())
	}

}

func signWithPvtkey(hashed []byte) ([]byte, error) {
	pemBlock, _ := ioutil.ReadFile("config/idp-samltools-privatekey.key")
	block, _ := pem.Decode(pemBlock)
	if block == nil {
		panic("failed to parse PEM block containing the private key")
	}

	pvt, err := x509.ParsePKCS8PrivateKey(block.Bytes)
	if err != nil {
		panic("failed to parse DER encoded public key: " + err.Error())
	}
	key := pvt.(*rsa.PrivateKey)

	return rsa.SignPKCS1v15(rand.Reader, key, crypto.SHA1, hashed)

}

func TestSignature(t *testing.T) {
	message := "this is some message"
	hash := crypto.SHA1.New()
	_, err := hash.Write([]byte(message))
	if err != nil {
		log.Fatalf("failed to create hash  %s", err.Error())
	}

	hashed := hash.Sum(nil)
	signature, err := signWithPvtkey(hashed)
	if err != nil {
		log.Fatalf("failed to create signature  %s", err.Error())
	}
	derBytesCert, err := base64.StdEncoding.DecodeString(Certb64)

	cert, err := x509.ParseCertificate(derBytesCert)
	if err != nil {
		log.Fatalf("x509 parse err %s\n", err.Error())

	}
	err = rsa.VerifyPKCS1v15(cert.PublicKey.(*rsa.PublicKey), crypto.SHA1, hashed, signature)
	if err != nil {
		log.Fatalf("check failed signature err %s\n", err.Error())

	}
}
